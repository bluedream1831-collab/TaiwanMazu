<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>ç²‰ç´…è¶…è·‘ï¼šV13.0 é»å¿ƒç«™è£œçµ¦ç‰ˆ</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto; 
        background-color: #a1c4fd;
        font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
        background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
        background-position: 0 0, 50px 50px;
        background-size: 100px 100px;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }

    .container-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 10px;
        box-sizing: border-box;
    }

    #gameContainer {
        position: relative;
        overflow: hidden;
        background: #fdfbf7;
        width: 800px;
        height: 450px;
        border: 4px solid #fff;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        transition: background 0.5s;
    }

    @media (max-width: 820px) {
        #gameContainer {
            width: 100%;
            max-width: 100%;
            height: 60vh; 
            min-height: 400px;
            aspect-ratio: auto;
            border-radius: 12px;
            margin-bottom: 20px;
        }
    }

    .bg-normal { background: linear-gradient(180deg, #89f7fe 0%, #66a6ff 100%); }
    .bg-fever { background: linear-gradient(180deg, #ff9a9e 0%, #fecfef 100%); }

    canvas { display: block; width: 100%; height: 100%; }

    #uiLayer {
        position: absolute;
        top: 15px; left: 15px;
        color: #e84393;
        font-size: 20px;
        font-weight: 900;
        text-shadow: 2px 2px 0 #fff;
        pointer-events: none;
        z-index: 10;
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    #muteBtn {
        pointer-events: auto;
        background: rgba(255, 255, 255, 0.8);
        border: 2px solid #e84393;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: transform 0.1s;
    }
    #muteBtn:active { transform: scale(0.9); }

    /* UI æç¤ºæ–‡å­— (å¦‚ï¼šè£œçµ¦æ¸›é€Ÿ) */
    .float-text {
        position: absolute;
        left: 50%;
        top: 40%;
        transform: translate(-50%, -50%);
        font-size: 30px;
        color: #27ae60;
        font-weight: bold;
        text-shadow: 2px 2px 0 #fff;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s, top 0.5s;
        z-index: 15;
    }
    .float-text.show {
        opacity: 1;
        top: 30%;
    }

    .screen {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        /* èƒŒæ™¯ç¨å¾®é€æ˜ä¸€é»ï¼Œè®“å¤§å®¶çœ‹åˆ°å¾Œé¢çš„å¤§è½å­ */
        background: rgba(255, 255, 255, 0.85); 
        text-align: center;
        color: #e84393;
        z-index: 20;
    }

    h1 { margin: 0 0 10px 0; font-size: 32px; text-shadow: 2px 2px 0px #ffeaa7; }
    p { font-size: 18px; color: #555; font-weight: bold; margin-bottom: 20px; }
    
    button {
        background: linear-gradient(to bottom, #ff9ff3, #f368e0);
        color: white;
        border: none;
        padding: 12px 40px;
        font-size: 22px;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 5px 0 #c445b0;
        font-weight: bold;
        transition: transform 0.1s;
        margin-bottom: 15px;
    }
    button:active { transform: translateY(5px); box-shadow: 0 0 0 #c445b0; }

    .author-link {
        font-size: 14px;
        color: #555;
        text-decoration: none;
        margin-top: 10px;
        font-weight: bold;
        background: rgba(255,255,255,0.8);
        padding: 6px 16px;
        border-radius: 20px;
        border: 1px solid #ddd;
    }
    .author-link a { color: #e84393; text-decoration: none; }
    
    .author-footer {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
        padding-bottom: 20px;
    }
    .author-footer a { color: #0984e3; font-weight: bold; }

</style>
</head>
<body>

<div class="container-wrapper">
    <div id="gameContainer" class="bg-normal">
        <canvas id="gameCanvas"></canvas>
        
        <div id="uiLayer">
            <div id="muteBtn" onclick="toggleMute()">ğŸ”Š</div>
            <div>ç¦æ°£: <span id="score">0</span></div>
            <div style="color:#0984e3">é€Ÿåº¦: <span id="level">1</span></div>
        </div>
        
        <!-- æµ®å‹•æç¤ºå­— -->
        <div id="msgText" class="float-text">åƒé£½äº†ï¼é€Ÿåº¦æ”¾æ…¢ ğŸ™</div>
        
        <div id="startScreen" class="screen">
            <!-- ç§»é™¤åŸæœ¬çš„ emoji div -->
            <!-- é€™è£¡ç•™ç©ºï¼Œæˆ‘å€‘æœƒç”¨ Canvas åœ¨èƒŒæ™¯ç•«ä¸€å€‹å¤§è½å­ -->
            <div style="height: 120px;"></div> 
            
            <h1>ç²‰ç´…è¶…è·‘ V13.0</h1>
            <p>æ–°å¢ã€Œé»å¿ƒç«™ã€ğŸ’ğŸ±<br>åƒé£½è£œå……é«”åŠ›ã€æ”¾æ…¢è…³æ­¥ï¼</p>
            <button onclick="startGame()">èµ·é§•å‡ºç™¼</button>
            
            <div class="author-link">
                è¨­è¨ˆè€…ï¼š<a href="https://vocus.cc/user/@WUCJ" target="_blank">WUCJ (æ–¹æ ¼å­)</a>
            </div>
        </div>

        <div id="gameOverScreen" class="screen" style="display: none;">
            <h1>ğŸ™ åœ“æ»¿é§é§• ğŸ™</h1>
            <p>æœ¬æ¬¡ç´¯ç©ç¦æ°£</p>
            <h2 style="font-size: 50px; margin: 10px 0; color: #d63031;" id="finalScore">0</h2>
            <button onclick="startGame()">å†æ¬¡èµ·é§•</button>
            
            <div class="author-link">
                <a href="https://vocus.cc/user/@WUCJ" target="_blank">é€›é€› WUCJ çš„éƒ¨è½æ ¼ â”</a>
            </div>
        </div>
    </div>

    <div class="author-footer">
        éŠæˆ²è¨­è¨ˆ by <a href="https://vocus.cc/user/@WUCJ" target="_blank">WUCJ</a>
    </div>
</div>

<script>
    // --- éŸ³æ•ˆç®¡ç†å™¨ ---
    const SoundManager = {
        ctx: null,
        isMuted: false,
        init: function() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!this.ctx) this.ctx = new AudioContext();
        },
        playTone: function(freq, type, duration, vol = 0.1) {
            if (this.isMuted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        playCollect: function() { this.playTone(880, 'sine', 0.1, 0.1); setTimeout(() => this.playTone(1760, 'sine', 0.1, 0.05), 50); },
        playHit: function() { this.playTone(150, 'sawtooth', 0.3, 0.1); this.playTone(100, 'square', 0.3, 0.1); },
        playFeverStart: function() { let now = this.ctx.currentTime; [523, 659, 783, 1046, 1318].forEach((freq, i) => { setTimeout(() => this.playTone(freq, 'triangle', 0.2, 0.1), i * 100); }); },
        playFeverCollect: function() { this.playTone(1200 + Math.random()*500, 'sine', 0.08, 0.05); },
        // æ–°å¢ï¼šåƒæ±è¥¿éŸ³æ•ˆ (å’•åš•è²)
        playEat: function() {
            if (this.isMuted || !this.ctx) return;
            this.playTone(400, 'sine', 0.1, 0.2);
            setTimeout(() => this.playTone(300, 'sine', 0.1, 0.2), 100);
        }
    };

    const container = document.getElementById('gameContainer');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const finalScoreEl = document.getElementById('finalScore');
    const muteBtn = document.getElementById('muteBtn');
    const msgText = document.getElementById('msgText');

    let gameRunning = false;
    let score = 0;
    let frames = 0;
    let animationId = null;
    
    let gameSpeed = 3;
    let difficultyLevel = 1;

    let isFeverMode = false;
    let feverTimer = 0;
    const FEVER_DURATION = 400;

    let canvasWidth = 800;
    let canvasHeight = 450;

    function toggleMute() {
        SoundManager.isMuted = !SoundManager.isMuted;
        muteBtn.innerText = SoundManager.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        if(window.event) window.event.stopPropagation();
    }

    function showMsg(text) {
        msgText.innerText = text;
        msgText.classList.add('show');
        setTimeout(() => msgText.classList.remove('show'), 1500);
    }

    function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        canvasWidth = rect.width;
        canvasHeight = rect.height;
        if(gameRunning) {
            player.targetY = Math.min(player.targetY, canvasHeight - 50);
        } else {
            // å¦‚æœéŠæˆ²æ²’åœ¨è·‘ï¼Œé‡ç•«å°é¢åœ–
            drawTitleArt();
        }
    }
    window.addEventListener('resize', resizeCanvas);

    const particles = [];
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            this.size = Math.random() * 8 + 3;
            this.speedX = Math.random() * 8 - 4;
            this.speedY = Math.random() * 8 - 4;
            this.color = color;
            this.life = 1;
        }
        update() {
            this.x += this.speedX; this.y += this.speedY;
            this.life -= 0.04; this.size *= 0.9;
        }
        draw() {
            ctx.fillStyle = this.color; ctx.globalAlpha = Math.max(0, this.life);
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill(); ctx.globalAlpha = 1;
        }
    }

    // --- ç¨ç«‹å‡ºä¾†çš„ç•«è½å­å‡½å¼ (ä¾›éŠæˆ²å’Œå°é¢ä½¿ç”¨) ---
    function drawPalanquin(ctx, x, y, scale = 1, bounce = 0) {
        ctx.save();
        ctx.translate(x, y + bounce);
        ctx.scale(scale, scale);

        // é™°å½±
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath(); ctx.ellipse(0, 35, 30, 8, 0, 0, Math.PI*2); ctx.fill();

        // è½æ£
        ctx.fillStyle = '#f1c40f'; ctx.fillRect(-35, 10, 70, 6);
        
        // è½èº« (ç²‰ç´…é ‚è“‹)
        ctx.fillStyle = '#ff9ff3'; 
        ctx.beginPath();
        ctx.moveTo(-25, 10); ctx.lineTo(25, 10); ctx.lineTo(30, -15); 
        ctx.quadraticCurveTo(0, -25, -30, -15);
        ctx.fill();

        // è£é£¾
        ctx.fillStyle = '#fdcb6e'; ctx.fillRect(-20, 10, 40, 20);
        ctx.fillStyle = '#d63031'; ctx.beginPath(); ctx.arc(0, -20, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'red'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; ctx.fillText('å‹‡', 0, 24);

        ctx.restore();
    }

    // --- ç•«å°é¢åœ– (å¤§è½å­) ---
    function drawTitleArt() {
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        
        // ç•«ä¸€äº›èƒŒæ™¯ç·š
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        for(let i=0; i<10; i++) {
            ctx.fillRect(Math.random()*canvasWidth, Math.random()*canvasHeight, Math.random()*50+20, 2);
        }

        // ç•«å¤§è½å­åœ¨ä¸­é–“åä¸Š (é…åˆ HTML çš„ç©ºç™½ div)
        // è®“å®ƒæœ‰é»ä¸Šä¸‹æµ®å‹•çš„æ„Ÿè¦º
        let floatY = Math.sin(Date.now() / 300) * 5; 
        drawPalanquin(ctx, canvasWidth/2, canvasHeight/2 - 40, 2.5, floatY);

        // å¦‚æœéœ€è¦æŒçºŒå‹•ç•«ï¼Œå¯ä»¥ requestAnimationFrameï¼Œé€™è£¡ç‚ºäº†çœé›»åªç•«ä¸€æ¬¡æˆ–åœ¨ resize é‡ç•«
        // ç‚ºäº†ç°¡å–®ï¼Œé€™è£¡éœæ…‹å³å¯ï¼Œæˆ–è€…åœ¨ animate å¤–éƒ¨åšä¸€å€‹ç°¡å–® loop (ä½†æœƒè¤‡é›œåŒ–)
        // æˆ‘å€‘è®“å®ƒéœæ…‹é¡¯ç¤ºå³å¯ï¼Œæˆ–è€…ç¨å¾®è®“å®ƒå‹•ä¸€ä¸‹
    }

    const player = {
        x: 0, y: 0, baseX: 0.15,
        width: 80, height: 60, targetY: 0,
        draw: function() {
            this.x = canvasWidth * this.baseX;
            const bounceSpeed = isFeverMode ? 0.8 : (0.3 + gameSpeed * 0.05);
            const bounce = Math.sin(frames * bounceSpeed) * 3;
            drawPalanquin(ctx, this.x, this.y, 1, bounce);
        },
        update: function() {
            let lerp = Math.min(0.25, 0.15 + (gameSpeed * 0.01));
            this.y += (this.targetY - this.y) * lerp;
            if(this.y < 40) this.targetY = 40;
            if(this.y > canvasHeight - 40) this.targetY = canvasHeight - 40;
        }
    };

    function drawCuteFurnace(ctx, x, y, size) {
        ctx.save();
        ctx.translate(x, y);
        const scale = size / 55;
        ctx.scale(scale, scale);
        ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(-5, -20); ctx.lineTo(-5, -35); ctx.moveTo(0, -20); ctx.lineTo(0, -40); ctx.moveTo(5, -20); ctx.lineTo(5, -35); ctx.stroke();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)'; let smokeOffset = Math.sin(frames * 0.1) * 3;
        ctx.beginPath(); ctx.arc(0 + smokeOffset, -45, 5, 0, Math.PI*2); ctx.arc(-3 + smokeOffset, -52, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#F1C40F'; ctx.beginPath(); ctx.ellipse(-28, -5, 8, 12, 0, 0, Math.PI*2); ctx.ellipse(28, -5, 8, 12, 0, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#DAA520'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(-28, 5, 5, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(28, 5, 5, 0, Math.PI*2); ctx.stroke();
        let grd = ctx.createLinearGradient(-20, -20, 20, 20); grd.addColorStop(0, '#e74c3c'); grd.addColorStop(1, '#c0392b');
        ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.ellipse(0, -22, 22, 6, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#DAA520'; ctx.beginPath(); ctx.roundRect(-20, 22, 40, 8, 5); ctx.fill();
        ctx.strokeStyle = '#333'; ctx.lineWidth = 2.5; ctx.beginPath(); ctx.arc(-10, -2, 4, Math.PI, 0); ctx.stroke(); ctx.beginPath(); ctx.arc(10, -2, 4, Math.PI, 0); ctx.stroke();
        ctx.fillStyle = '#ff9ff3'; ctx.globalAlpha = 0.6; ctx.beginPath(); ctx.arc(-15, 5, 4, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(15, 5, 4, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0;
        ctx.fillStyle = '#8e44ad'; ctx.beginPath(); ctx.arc(0, 5, 6, 0, Math.PI); ctx.fill();
        ctx.restore();
    }

    const items = [];
    const itemTypes = [
        { emoji: 'ğŸ®', type: 'good', points: 10, size: 45, color: '#e17055' },
        { emoji: 'ğŸ‘', type: 'good', points: 20, size: 45, color: '#ff7675' },
        { emoji: 'ğŸ’¥', type: 'bad', points: 0, size: 40 }, 
        { emoji: '', type: 'trigger', points: 50, size: 55, color: '#fdcb6e' },
        // æ–°å¢ï¼šè£œçµ¦å“ (é»å¿ƒç«™) - ğŸ’ğŸ±
        { emoji: 'ğŸ’ğŸ±', type: 'supply', points: 30, size: 50, color: '#2ecc71' } 
    ];
    const believerItem = { emoji: 'ğŸ™‡', type: 'fever', points: 50, size: 55, color: '#ffeaa7' };

    class Item {
        constructor(forceType = null) {
            if (forceType) { this.typeData = forceType; } 
            else {
                let rand = Math.random();
                // èª¿æ•´æ©Ÿç‡ï¼šå¢åŠ è£œçµ¦å“
                if (rand < 0.10) this.typeData = itemTypes[3]; // é‡‘çˆ 10%
                else if (rand < 0.20) this.typeData = itemTypes[4]; // è£œçµ¦å“ 10%
                else if (rand < 0.50) this.typeData = itemTypes[2]; // ç‚¸å½ˆ 30%
                else this.typeData = itemTypes[rand < 0.75 ? 1 : 0]; // æ¡ƒå­/ç‡ˆç± 
            }

            this.x = canvasWidth + 50;
            if (this.typeData.type === 'fever' || this.typeData.type === 'supply') {
                 // ä¿¡å¾’å’Œè£œçµ¦éƒ½åœ¨ä¸‹æ–¹æ¯”è¼ƒåˆç†
                 this.y = canvasHeight - 70 - (Math.random() * 20); 
            } else {
                 this.y = Math.random() * (canvasHeight - 120) + 60;
            }
            this.speed = gameSpeed + Math.random() * 2;
            this.markedForDeletion = false;
        }
        draw() {
            if (this.typeData.type === 'trigger') {
                drawCuteFurnace(ctx, this.x, this.y, this.typeData.size);
            } else {
                ctx.font = `${this.typeData.size}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.typeData.emoji, this.x, this.y);
            }
        }
        update() {
            let currentSpeed = isFeverMode ? this.speed * 1.5 : this.speed;
            this.x -= currentSpeed;
            if (this.x < -50) this.markedForDeletion = true;

            const dist = Math.hypot(this.x - player.x, this.y - player.y);
            if (dist < 60) {
                // ç¢°æ’è™•ç†
                if (this.typeData.type === 'bad') {
                    if (!isFeverMode) { SoundManager.playHit(); endGame(); }
                } 
                else if (this.typeData.type === 'trigger') {
                    startFeverMode(); SoundManager.playFeverStart();
                    this.markedForDeletion = true; createExplosion(this.x, this.y, '#fdcb6e');
                }
                else if (this.typeData.type === 'supply') {
                    // --- è£œçµ¦å“é‚è¼¯ ---
                    score += this.typeData.points;
                    scoreEl.innerText = score;
                    SoundManager.playEat(); // æ’­æ”¾åƒæ±è¥¿éŸ³æ•ˆ
                    
                    // æ¸›é€Ÿæ•ˆæœï¼šæœ€ä½é™åˆ° 3ï¼Œæ¯æ¬¡é™ 2
                    if (gameSpeed > 3) {
                        gameSpeed = Math.max(3, gameSpeed - 1.5);
                        showMsg("è£œçµ¦é«”åŠ›! æ¸›é€Ÿ ğŸ™");
                    } else {
                        showMsg("é«”åŠ›å……æ²›! åŠ åˆ† ğŸ’ª");
                    }
                    
                    this.markedForDeletion = true;
                    createExplosion(this.x, this.y, '#2ecc71');
                }
                else {
                    score += this.typeData.points;
                    scoreEl.innerText = score;
                    if(this.typeData.type === 'fever') SoundManager.playFeverCollect();
                    else SoundManager.playCollect();
                    this.markedForDeletion = true;
                    createExplosion(this.x, this.y, this.typeData.color);
                    updateDifficulty();
                }
            }
        }
    }

    function updateDifficulty() {
        // é›£åº¦éš¨åˆ†æ•¸å¢åŠ ï¼Œä½†å¦‚æœå‰›å‰›åƒäº†è£œçµ¦å“ï¼Œé€™è£¡å¢åŠ çš„é€Ÿåº¦æœƒè¢«ä¸Šé¢çš„æ¸›é€ŸæŠµéŠ·ä¸€éƒ¨åˆ†
        let newLevel = 1 + Math.floor(score / 50);
        if (newLevel > difficultyLevel) {
            difficultyLevel = newLevel;
            let targetSpeed = 3 + (difficultyLevel * 0.5); 
            // åªæœ‰ç•¶ç›®æ¨™é€Ÿåº¦æ¯”ç¾åœ¨å¿«æ™‚æ‰åŠ é€Ÿ (é¿å…åƒäº†è£œçµ¦åˆé¦¬ä¸Šè®Šå¿«)
            if (targetSpeed > gameSpeed) {
                gameSpeed = Math.min(12, targetSpeed);
            }
            levelEl.innerText = difficultyLevel;
        }
    }

    function createExplosion(x, y, color) {
        for(let i=0; i<10; i++) particles.push(new Particle(x, y, color));
    }

    function startFeverMode() {
        if (isFeverMode) { feverTimer = FEVER_DURATION; return; }
        isFeverMode = true;
        feverTimer = FEVER_DURATION;
        container.classList.remove('bg-normal');
        container.classList.add('bg-fever');
        items.forEach(item => { if(item.typeData.type === 'bad') item.markedForDeletion = true; });
    }

    function endFeverMode() {
        isFeverMode = false;
        container.classList.remove('bg-fever');
        container.classList.add('bg-normal');
    }

    const lines = [];
    class SpeedLine {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * canvasWidth;
            this.y = Math.random() * canvasHeight;
            this.width = Math.random() * 20 + 10;
            this.speed = Math.random() * 10 + 5;
        }
        update() {
            let s = isFeverMode ? (this.speed + gameSpeed) * 1.5 : this.speed + gameSpeed;
            this.x -= s;
            if(this.x < -50) this.reset();
        }
        draw() {
            ctx.fillStyle = isFeverMode ? 'rgba(255, 255, 255, 0.6)' : 'rgba(255, 255, 255, 0.4)';
            ctx.fillRect(this.x, this.y, this.width, isFeverMode ? 4 : 2);
        }
    }
    for(let i=0; i<15; i++) lines.push(new SpeedLine());

    const keys = {};
    document.addEventListener('keydown', e => keys[e.code] = true);
    document.addEventListener('keyup', e => keys[e.code] = false);

    container.addEventListener('touchstart', handleTouch, {passive: false});
    container.addEventListener('touchmove', handleTouch, {passive: false});
    
    function handleTouch(e) {
        if (!gameRunning) return;
        e.preventDefault();
        const rect = container.getBoundingClientRect();
        let touchY = e.touches[0].clientY - rect.top;
        player.targetY = touchY - 50;
    }

    function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
        if (typeof radius === 'undefined') radius = 5;
        ctx.beginPath(); ctx.moveTo(x + radius, y); ctx.lineTo(x + width - radius, y); ctx.quadraticCurveTo(x + width, y, x + width, y + radius); ctx.lineTo(x + width, y + height - radius); ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height); ctx.lineTo(x + radius, y + height); ctx.quadraticCurveTo(x, y + height, x, y + height - radius); ctx.lineTo(x, y + radius); ctx.quadraticCurveTo(x, y, x + radius, y); ctx.closePath();
        if (fill) ctx.fill(); if (stroke) ctx.stroke();
    }

    function drawGameUI() {
        if (!isFeverMode) return;
        ctx.save();
        let cx = canvasWidth / 2;
        let cy = canvasHeight * 0.25;
        let scale = 1 + Math.sin(frames * 0.15) * 0.05;

        ctx.translate(cx, cy);
        ctx.scale(scale, scale);

        ctx.font = 'bold 36px "å¾®è»Ÿæ­£é»‘é«”"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#ffff00';
        ctx.shadowBlur = 15;
        ctx.fillStyle = '#d63031';
        ctx.fillText("ğŸ™ æ­£åœ¨é‘½è½åº• ğŸ™", 0, 0);
        ctx.shadowBlur = 0;

        let boxW = 280; let boxH = 40; let boxY = 40;
        ctx.fillStyle = '#d63031';
        roundRect(ctx, -boxW/2, boxY, boxW, boxH, 20, true, false);

        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 18px "å¾®è»Ÿæ­£é»‘é«”"';
        ctx.fillText("ç¢°è§¸ä¿¡å¾’è³œç¦åŠ åˆ†ï¼", 0, boxY + boxH/2);
        ctx.restore();
    }

    // --- ç°¡å–®çš„æ¨™é¡Œç•«é¢å‹•ç•« Loop ---
    function titleLoop() {
        if (!gameRunning) {
            drawTitleArt();
            requestAnimationFrame(titleLoop);
        }
    }

    function animate() {
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        lines.forEach(line => { line.update(); line.draw(); });

        if (keys.ArrowUp) player.targetY -= 9;
        if (keys.ArrowDown) player.targetY += 9;
        player.update();
        player.draw();

        let spawnRate = isFeverMode ? 10 : Math.max(20, 60 - difficultyLevel * 3);
        if (frames % spawnRate === 0) {
            if (isFeverMode) items.push(new Item(believerItem)); 
            else items.push(new Item());
        }

        for (let i = items.length - 1; i >= 0; i--) {
            items[i].update();
            items[i].draw();
            if (items[i].markedForDeletion) items.splice(i, 1);
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }

        drawGameUI();

        if (isFeverMode) {
            feverTimer--;
            if (feverTimer <= 0) endFeverMode();
        }

        frames++;
        if (gameRunning) animationId = requestAnimationFrame(animate);
    }

    function startGame() {
        SoundManager.init();
        if(SoundManager.ctx && SoundManager.ctx.state === 'suspended') SoundManager.ctx.resume();

        if (animationId) cancelAnimationFrame(animationId);
        resizeCanvas();
        gameRunning = true;
        score = 0;
        frames = 0;
        gameSpeed = 3; 
        difficultyLevel = 1;
        levelEl.innerText = difficultyLevel;

        items.length = 0;
        particles.length = 0;
        isFeverMode = false;
        container.classList.remove('bg-fever');
        container.classList.add('bg-normal');
        
        scoreEl.innerText = score;
        player.y = canvasHeight / 2;
        player.targetY = canvasHeight / 2;
        
        startScreen.style.display = 'none';
        gameOverScreen.style.display = 'none';
        animate();
    }

    function endGame() {
        gameRunning = false;
        if (animationId) cancelAnimationFrame(animationId);
        finalScoreEl.innerText = score;
        gameOverScreen.style.display = 'flex';
        container.classList.remove('bg-fever');
        
        // éŠæˆ²çµæŸå¾Œï¼Œå•Ÿå‹•æ¨™é¡Œç•«é¢çš„å‹•ç•«
        titleLoop();
    }
    
    // åˆå§‹è¼‰å…¥
    resizeCanvas();
    titleLoop(); // å•Ÿå‹•å°é¢å‹•ç•«

</script>
</body>
</html>
